# app.py (Streamlit UI ë° LLM ì‹¤í–‰)

# --- LLM ì‹¤í–‰ ë° Tool Call ì²˜ë¦¬ í•¨ìˆ˜ ---
def run_master_agent(user_prompt: str, location: str, structure_name: str):
    messages = [{"role": "user", "content": user_prompt}]
    tool_results = {}
    
    # LLMê³¼ Tools ê°„ì˜ ëŒ€í™” ë£¨í”„ (ìµœëŒ€ 3íšŒ ë°˜ë³µ)
    for _ in range(3):
        response = client.chat.completions.create(
            model="gpt-4o-mini",
            messages=messages,
            tools=tools,
            tool_choice="auto",
        )
        
        response_message = response.choices[0].message
        
        # 1. Tool Callì´ ìˆëŠ”ì§€ í™•ì¸
        if not response_message.tool_calls:
            # ìµœì¢… ë¶„ì„ ê²°ê³¼ í…ìŠ¤íŠ¸ ë°˜í™˜
            return response_message.content, tool_results
        
        # 2. Tool Call ì‹¤í–‰
        messages.append(response_message)
        
        for tool_call in response_message.tool_calls:
            function_name = tool_call.function.name
            function_args = json.loads(tool_call.function.arguments)
            
            st.info(f"ì—ì´ì „íŠ¸ê°€ ì™¸ë¶€ ë„êµ¬ í˜¸ì¶œ: {function_name}")
            
            # í•¨ìˆ˜ ì‹¤í–‰
            if function_name == "get_heritage_text_record":
                function_args['location'] = location
                function_args['structure_name'] = structure_name
            
            # Mock í•¨ìˆ˜ ì‹¤í–‰
            function_response = available_functions[function_name](**function_args)
            
            # Tool ì‹¤í–‰ ê²°ê³¼ë¥¼ ì €ì¥í•˜ê³  LLMì—ê²Œ ì „ë‹¬
            tool_results[function_name] = json.loads(function_response)
            messages.append(
                {"tool_call_id": tool_call.id, "role": "tool", "content": function_response}
            )
            
    # ë£¨í”„ ì¢…ë£Œ í›„ ìµœì¢… ì‘ë‹µ ë°˜í™˜
    final_response = client.chat.completions.create(model="gpt-4o-mini", messages=messages)
    return final_response.choices[0].message.content, tool_results


# --- Streamlit UI ì‹œì‘ ---
st.title("ğŸŒ ì§€ì—­ ë¬¸í™”ìœ ì‚° ë””ì§€í„¸ ë§ˆìŠ¤í„° ì—ì´ì „íŠ¸")
st.markdown("ì—­ì‚¬ ê¸°ë¡ì„ ë¶„ì„í•˜ê³  í›¼ì†ëœ ë¬¸í™”ìœ ì‚°ì„ ë””ì§€í„¸ë¡œ ë³µì›í•©ë‹ˆë‹¤.")

# ì‚¬ì´ë“œë°” (ì…ë ¥ ì˜ì—­)
with st.sidebar:
    st.header("ë¬¸í™”ìœ ì‚° ì •ë³´ ì…ë ¥")
    # 1. ì§€ì—­ ë° êµ¬ì¡°ë¬¼ ì´ë¦„ ì…ë ¥ (Tool 1ì˜ ì…ë ¥)
    location = st.text_input("ì§€ì—­:", "ì„œìš¸ ì¢…ë¡œ")
    structure_name = st.text_input("ë¬¸í™”ìœ ì‚° ì´ë¦„/íŠ¹ì§•:", "ê²½ë³µê¶ ì‚¬ì •ì „")
    location_data = st.text_input("ì§€í˜• ë°ì´í„°:", "í‰ì§€")
    
    # 2. ë¶„ì„ ìš”ì²­ í”„ë¡¬í”„íŠ¸
    prompt = st.text_area(
        "AI ë¶„ì„ ë° ë³µì› ìš”ì²­:", 
        f"'{structure_name}'ì˜ ì—­ì‚¬ ê¸°ë¡ì„ ê²€ìƒ‰í•˜ê³ , ê·¸ ê¸°ë¡ì„ ë°”íƒ•ìœ¼ë¡œ ë³µì›í•  ë•Œì˜ ì‹œê°ì ì¸ ë¬˜ì‚¬ë¥¼ ìƒì„±í•´ ì¤˜. ê·¸ë¦¬ê³  ë³µì›ëœ ëª¨ìŠµì„ ì´ë¯¸ì§€ë¡œ ì‹œë®¬ë ˆì´ì…˜í•´ ì¤˜.",
        height=150
    )

# ë©”ì¸ ì‹¤í–‰ ë²„íŠ¼
if st.button("ğŸ” ë¶„ì„ ë° ë³µì› ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰"):
    if structure_name and prompt:
        with st.spinner("AI ì—ì´ì „íŠ¸ê°€ ì—­ì‚¬ ê¸°ë¡ì„ ê²€ìƒ‰í•˜ê³  ë³µì› ëª…ë ¹ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
            
            # ì—ì´ì „íŠ¸ ì‹¤í–‰
            analysis_text, tool_results = run_master_agent(prompt, location, structure_name)
            
            st.subheader("ğŸ’¡ ì—ì´ì „íŠ¸ ë¶„ì„ ê²°ê³¼ ë° ìŠ¤í† ë¦¬í…”ë§")
            st.write(analysis_text)
            
            if "get_heritage_text_record" in tool_results:
                record = tool_results["get_heritage_text_record"]
                if record.get("status") == "success":
                    st.subheader("ğŸ“œ ê²€ìƒ‰ëœ ì—­ì‚¬ ê¸°ë¡")
                    st.code(record["text_record"], language='markdown')
                    
                    # 3D ë³µì› ê²°ê³¼ í‘œì‹œ
                    if "call_3d_restoration_api" in tool_results:
                        restored = tool_results["call_3d_restoration_api"]
                        if restored.get("status") == "success":
                            st.subheader("âœ¨ ë””ì§€í„¸ ë³µì› ì‹œë®¬ë ˆì´ì…˜ ê²°ê³¼")
                            col1, col2 = st.columns(2)
                            with col1:
                                st.text("ì›ë³¸ ì´ë¯¸ì§€ (ê¸°ë¡ì— ì˜í•´ ê°€ì •)")
                                st.image(record["original_image_url"], caption="í›¼ì†ë˜ê±°ë‚˜ ì†Œì‹¤ëœ ìœ ì‚°")
                            with col2:
                                st.text("AI ë³µì› ì‹œë®¬ë ˆì´ì…˜")
                                st.image(restored["restored_url"], caption="ê¸°ë¡ ê¸°ë°˜ ë³µì›")
                            
    else:
        st.warning("ë¬¸í™”ìœ ì‚° ì´ë¦„ê³¼ ë¶„ì„ ìš”ì²­ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
